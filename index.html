<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="FitLoop - Pro Interval Timer">
    <title>FitLoop Pro</title>
    <style>
        /* --- Design System & Variables --- */
        :root {
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-top: env(safe-area-inset-top, 0px);
            
            /* Dark Mode (Default) */
            --bg-body: #121212;
            --bg-gradient: linear-gradient(160deg, #2c3e50 0%, #000000 120%);
            
            --glass-surface: rgba(30, 30, 30, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.1);
            --glass-blur: 30px;
            
            --icon-box-bg: rgba(255, 255, 255, 0.08);
            --icon-box-border: rgba(255, 255, 255, 0.05);
            
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-tertiary: rgba(255, 255, 255, 0.45);
            
            --accent-color: #0A84FF;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.2); 
            
            /* Language Modal (Dark) */
            --lang-opt-bg: rgba(40, 40, 40, 0.8);
            --lang-opt-border: rgba(255, 255, 255, 0.1);
            
            --state-bg-idle: transparent;
            --state-bg-work: rgba(120, 10, 10, 0.65); 
            --state-bg-rest: rgba(10, 80, 20, 0.65);  
            /* [FIX] Warmup is now Orange */
            --state-bg-warmup: rgba(255, 159, 10, 0.65);
            --state-bg-finish: rgba(20, 60, 120, 0.65);
            --state-bg-jog: rgba(90, 30, 140, 0.65); /* Purple for Jog */

            /* Action Button Gradients */
            --btn-go-bg: linear-gradient(135deg, #30D158 0%, #20aa45 100%);
            --btn-go-shadow: 0 4px 20px rgba(48, 209, 88, 0.3);
            --btn-pause-bg: linear-gradient(135deg, #FF9F0A 0%, #d48000 100%);
            --btn-pause-shadow: 0 4px 20px rgba(255, 159, 10, 0.3);
        }

        /* Light Mode */
        [data-theme="light"] {
            --bg-body: #F2F4F7;
            --bg-gradient: linear-gradient(160deg, #E0EAFC 0%, #CFDEF3 100%);
            
            --glass-surface: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --glass-blur: 30px;
            
            --icon-box-bg: rgba(0, 0, 0, 0.04); 
            --icon-box-border: rgba(0, 0, 0, 0.06); 
            
            --text-primary: #1c1c1e;
            --text-secondary: rgba(60, 60, 67, 0.7);
            --text-tertiary: rgba(60, 60, 67, 0.4);
            
            --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.03);
            
            --lang-opt-bg: #ffffff;
            --lang-opt-border: rgba(0, 0, 0, 0.1);
            
            --state-bg-idle: transparent;
            --state-bg-work: rgba(255, 59, 48, 0.2);
            --state-bg-rest: rgba(48, 209, 88, 0.2);
            /* [FIX] Warmup is now Orange */
            --state-bg-warmup: rgba(255, 149, 0, 0.2);
            --state-bg-finish: rgba(10, 132, 255, 0.2);
            --state-bg-jog: rgba(175, 82, 222, 0.2);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        button, input, select { -webkit-appearance: none; appearance: none; border-radius: 0; font-family: inherit; }

        html, body { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            background-color: #121212; 
            color: var(--text-primary); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            overflow: hidden; 
            position: fixed;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        /* Double Layer Background System */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -5;
            transition: opacity 0.6s ease;
            background-size: cover;
            background-attachment: scroll;
            pointer-events: none;
        }

        #bg-layer-dark { background-image: linear-gradient(160deg, #2c3e50 0%, #000000 120%); opacity: 0; }
        #bg-layer-light { background-image: linear-gradient(160deg, #E0EAFC 0%, #CFDEF3 100%); opacity: 0; }

        [data-theme="dark"] #bg-layer-dark { opacity: 1; }
        [data-theme="dark"] #bg-layer-light { opacity: 0; }
        [data-theme="dark"] { background-color: #121212; }

        [data-theme="light"] #bg-layer-dark { opacity: 0; }
        [data-theme="light"] #bg-layer-light { opacity: 1; }
        [data-theme="light"] { background-color: #F2F4F7; }


        #state-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--state-bg-idle);
            pointer-events: none; z-index: -1; 
            transition: background-color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .icon-svg { width: 24px; height: 24px; fill: currentColor; display: block; pointer-events: none; }
        .icon-lg { width: 32px; height: 32px; }
        .hidden { display: none !important; }

        #app-container { 
            width: 100%; height: 100dvh; 
            margin: 0 auto; max-width: 500px; 
            display: flex; flex-direction: column; 
            position: relative; 
            z-index: 10;
        }

        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; display: none; }
        #confetti-canvas.active { display: block; }
        
        .screen { 
            flex: 1; display: flex; flex-direction: column; 
            padding: 24px; overflow: hidden; 
            transition: opacity 0.3s ease, transform 0.3s ease; 
            padding-bottom: calc(24px + var(--safe-bottom)); 
            padding-top: calc(12px + var(--safe-top));
        }

        /* --- Header --- */
        .header { 
            margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 44px; 
            padding-left: 8px;
        }
        .app-title { 
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px; font-style: italic; 
            background: linear-gradient(135deg, var(--text-primary) 30%, var(--text-secondary) 100%); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-actions { display: flex; gap: 12px; }
        
        .btn-pill { 
            background: var(--glass-surface); 
            backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px; height: 40px; padding: 0 16px; 
            display: flex; align-items: center; gap: 8px; 
            font-size: 14px; font-weight: 600; cursor: pointer; 
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            transition: transform 0.1s, background 0.2s; 
            -webkit-appearance: none; 
        }
        .btn-pill:active { transform: scale(0.94); background: var(--glass-highlight); }
        .btn-icon-only { padding: 0; width: 40px; justify-content: center; }

        /* --- Dashboard Grid --- */
        .card-grid { 
            flex: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; 
            padding-bottom: 120px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; align-content: start;
        }
        .card-grid::-webkit-scrollbar { display: none; }
        
        .mode-card { 
            background: var(--glass-surface);
            backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 28px; 
            padding: 22px; 
            display: flex; flex-direction: column; align-items: flex-start; justify-content: space-between;
            gap: 16px; cursor: pointer; 
            box-shadow: var(--shadow-soft);
            transition: transform 0.1s; 
            min-height: 160px; position: relative; overflow: hidden;
            transform: translateZ(0);
        }
        .mode-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-highlight), transparent);
            opacity: 0.4; pointer-events: none;
        }
        .mode-card:active { transform: scale(0.96); }
        
        .resume-badge {
            display: none;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            background: rgba(255, 159, 10, 0.2); color: #FF9F0A;
            border: 1px solid rgba(255, 159, 10, 0.4);
            padding: 4px 10px; border-radius: 12px;
            margin-top: auto;
        }
        .mode-card.has-save .resume-badge { display: inline-block; }
        .mode-card.has-save .card-desc { display: none; }

        /* Wide Card for Jog */
        .mode-card.card-wide {
            grid-column: span 2;
            flex-direction: row; align-items: center;
            min-height: 120px;
        }
        .card-wide .card-text-box { margin-left: 12px; }

        .card-icon-box { 
            width: 52px; height: 52px; border-radius: 16px; 
            background: var(--icon-box-bg); 
            display: flex; align-items: center; justify-content: center; 
            color: var(--card-color); 
            border: 1px solid var(--icon-box-border);
            flex-shrink: 0;
        }
        .card-text-box { display: flex; flex-direction: column; gap: 6px; width: 100%; }
        .card-title { font-size: 19px; font-weight: 700; line-height: 1.1; letter-spacing: -0.3px; }
        .card-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.3; font-weight: 500; }

        /* --- Timer Screen --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 44px; margin-bottom: 10px; flex-shrink: 0; position: relative; }
        .btn-back { background: none; border: none; color: var(--text-primary); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; opacity: 0.9; padding: 10px 0; z-index: 2; transition: opacity 0.3s; cursor: pointer; -webkit-appearance: none; }
        .btn-locked { opacity: 0.3; cursor: not-allowed; pointer-events: none; } 
        
        .total-remain-badge { 
            position: absolute; left: 50%; transform: translateX(-50%); 
            background: var(--glass-surface); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); 
            padding: 8px 18px; border-radius: 24px; 
            font-size: 15px; font-variant-numeric: tabular-nums; 
            color: var(--text-secondary); font-weight: 600; 
            white-space: nowrap; z-index: 1; 
            box-shadow: var(--shadow-soft);
        }
        
        .timer-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; min-height: 0; }
        .timer-ring-svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg); width: 340px; height: 340px; pointer-events: none; z-index: 0; max-width: 85vw; max-height: 85vw; filter: drop-shadow(0 0 15px rgba(0,0,0,0.2)); }
        .ring-bg { fill: none; stroke: var(--glass-border); stroke-width: 8; }
        .ring-progress { fill: none; stroke: var(--accent-color); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 1005; stroke-dashoffset: 0; filter: drop-shadow(0 0 10px var(--accent-color)); }
        
        /* [NEW] Visual Metronome Needle - JS Driven Physics */
        .metro-needle {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 155px; 
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            transform-origin: bottom center;
            margin-left: -4px; margin-top: -155px; 
            opacity: 0; 
            z-index: 0;
            transition: opacity 0.3s;
            /* No CSS transition for transform to ensure instant JS updates */
        }
        .metro-needle::after {
            content: ''; position: absolute; top: 12px; left: 50%;
            width: 24px; height: 24px;
            transform: translateX(-50%);
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-color);
        }
        .metro-needle.active {
            opacity: 1;
        }

        .status-text { font-size: clamp(24px, 5vw, 32px); font-weight: 800; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 10px; z-index: 1; color: var(--text-secondary); text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .timer-digits { font-size: clamp(70px, 18vw, 110px); font-weight: 700; z-index: 1; font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -2px; color: var(--text-primary); text-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        
        /* Rounds / BPM Display */
        .timer-sub { font-size: 20px; color: var(--text-tertiary); margin-top: 12px; font-weight: 600; z-index: 2; height: 40px; display: flex; align-items: center; justify-content: center;}

        /* [NEW] BPM Controls */
        .bpm-controls { display: flex; align-items: center; gap: 16px; background: rgba(0,0,0,0.2); padding: 4px 12px; border-radius: 20px; border: 1px solid var(--glass-border); }
        .bpm-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--glass-surface); border: 1px solid var(--glass-border); color: var(--text-primary); font-size: 18px; font-weight: 600; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; user-select: none; }
        .bpm-btn:active { background: var(--accent-color); border-color: transparent; }
        .bpm-val { font-size: 18px; font-weight: 700; color: var(--text-primary); font-variant-numeric: tabular-nums; min-width: 40px; text-align: center; }
        .bpm-label { font-size: 12px; color: var(--text-secondary); margin-left: 4px; font-weight: 600; }

        /* --- Controls --- */
        .controls-wrapper { 
            background: var(--glass-surface); 
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); 
            border-radius: 36px; padding: 24px; 
            box-shadow: var(--shadow-soft);
            z-index: 2; flex-shrink: 0; margin-bottom: var(--safe-bottom);
        }
        .tools-row { display: flex; gap: 12px; margin-bottom: 20px; height: 68px; }
        .tool-btn { 
            flex: 1; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 20px; 
            padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
            color: var(--text-primary); transition: all 0.1s; cursor: pointer;
            -webkit-appearance: none; 
        }
        .tool-btn:active { background: var(--glass-highlight); transform: scale(0.98); }
        .tool-btn.btn-active-green { background: rgba(48, 209, 88, 0.15) !important; border-color: rgba(48, 209, 88, 0.5) !important; color: #30D158 !important; }
        .tool-btn.disabled { opacity: 0.3; pointer-events: none; }
        .tool-icon-wrap { height: 24px; width: 24px; display: flex; align-items: center; justify-content: center; }
        .tool-label { font-size: 11px; font-weight: 600; opacity: 0.8; text-align: center; }

        .main-actions { display: flex; gap: 12px; height: 68px; }
        
        .action-btn { 
            height: 100%; border-radius: 22px; border: none; font-size: 18px; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 0 16px;
            transition: transform 0.1s, background 0.3s, box-shadow 0.3s;
            will-change: transform; position: relative; overflow: hidden; 
            -webkit-appearance: none; 
            white-space: nowrap; 
        }
        
        .btn-stop { flex: 1; background: rgba(255, 59, 48, 0.15); color: #ff453a; border: 1px solid rgba(255, 59, 48, 0.3); font-size: 16px; transition: opacity 0.3s, transform 0.1s; }
        .btn-stop:active { background: rgba(255, 59, 48, 0.3); transform: scale(0.96); }
        
        .btn-play { 
            flex: 1.8; 
            background: var(--btn-go-bg);
            box-shadow: var(--btn-go-shadow);
            color: #ffffff; 
        }
        .btn-play.running {
            background: var(--btn-pause-bg);
            box-shadow: var(--btn-pause-shadow);
        }
        .btn-play:active { transform: scale(0.96); opacity: 0.9; }

        #play-icon-wrap {
            display: flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; height: 100%; pointer-events: none;
        }
        .btn-pulse::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 22px; box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7);
            animation: pulse-ring 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
            pointer-events: none;
        }
        @keyframes pulse-ring { to { box-shadow: 0 0 0 12px rgba(255, 59, 48, 0); } }

        /* --- Modals --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 999; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-sheet { 
            width: 100%; background: var(--bg-body); color: var(--text-primary);
            border-top-left-radius: 32px; border-top-right-radius: 32px; padding: 28px; max-height: 85%; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 -10px 50px rgba(0,0,0,0.5); padding-bottom: 50px; 
            border-top: 1px solid var(--glass-border);
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
        .sheet-title { font-size: 22px; font-weight: 800; }
        .sheet-close { color: var(--accent-color); background: none; border: none; font-size: 16px; font-weight: 700; padding: 5px; cursor: pointer; -webkit-appearance: none; }
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; background: var(--glass-surface); padding: 18px; margin-bottom: 1px; border: 1px solid var(--glass-border); border-bottom: none; }
        .setting-row:first-of-type { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .setting-row:last-of-type { border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; margin-bottom: 16px; border-bottom: 1px solid var(--glass-border); }
        .setting-row.hidden { display: none; }

        .input-group { display: flex; align-items: center; gap: 8px; }
        .nice-input { background: rgba(0,0,0,0.1); border: 1px solid var(--glass-border); color: var(--text-primary); width: 54px; padding: 10px 0; border-radius: 12px; text-align: center; font-size: 18px; font-weight: 600; -webkit-user-select: text; user-select: text; transition: border 0.2s; -webkit-appearance: none;}
        .nice-input:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.2); }
        .unit { font-size: 14px; color: var(--text-secondary); }
        
        .nice-select { background: rgba(0,0,0,0.1); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 10px 16px; border-radius: 12px; font-size: 16px; font-weight: 500; -webkit-appearance: none; text-align-last: right; }

        .total-est-box { background: var(--glass-surface); color: var(--text-secondary); text-align: center; padding: 14px; border-radius: 16px; margin-bottom: 24px; font-size: 15px; font-weight: 500; border: 1px solid var(--glass-border); }

        #info-content { color: var(--text-secondary); line-height: 1.6; font-size: 15px; }
        #info-content h3 { color: var(--accent-color); margin-top: 0; margin-bottom: 12px; font-size: 22px; }
        #info-content h4 { color: var(--text-primary); margin: 16px 0 8px 0; font-size: 16px; font-weight: 700; border-left: 3px solid var(--accent-color); padding-left: 10px; }
        #info-content strong { color: var(--text-primary); font-weight: 600; }
        
        .lang-opt { 
            padding: 18px; 
            background: var(--lang-opt-bg); 
            border-radius: 16px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background 0.2s; 
            border: 1px solid var(--lang-opt-border); 
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .lang-opt:active { background: var(--glass-highlight); }
        .selected-opt { border-color: var(--accent-color); background: rgba(255,255,255,0.05); }

    </style>
</head>
<body>

<svg style="display: none;">
    <symbol id="icon-lang" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></symbol>
    <symbol id="icon-theme-dark" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></symbol>
    <symbol id="icon-theme-light" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></symbol>
    <symbol id="icon-tabata" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></symbol>
    <symbol id="icon-hiit" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></symbol>
    <symbol id="icon-emom" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2v11h3v9l7-12h-4l4-8z"/></symbol>
    <symbol id="icon-gym" viewBox="0 0 24 24"><path fill="currentColor" d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 21.29 21.29 19.86l-1.43-1.43L22 16.29z"/></symbol>
    <symbol id="icon-jog" viewBox="0 0 24 24"><path fill="currentColor" d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 6.8 1.4z"/></symbol> 
    <symbol id="icon-back" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
    <symbol id="icon-info" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></symbol>
    <symbol id="icon-warmup" viewBox="0 0 24 24"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-2V5c0-.55.45-1 1-1s1 .45 1 1v1h-1v1h1v1h-1v1h1v2H11z"/></symbol>
    <symbol id="icon-metronome" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2c-.55 0-1 .45-1 1v1.17C7.36 4.85 5 8.65 5 12h2c0-3.31 2.69-6 6-6s6 2.69 6 6h2c0-3.35-2.36-7.15-6-7.83V3c0-.55-.45-1-1-1zM7 21h10v-2H7v2zM13.03 6.06L11.59 9 9.3 16.3c-.23.75.21 1.54.99 1.68.75.14 1.5-.32 1.67-1.09L13.7 7.21c.09-.43-.17-.85-.59-1.04-.02-.01-.05-.01-.08-.01z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></symbol>
    <symbol id="icon-stop" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></symbol>
    <symbol id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></symbol>
    <symbol id="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></symbol>
    <symbol id="icon-sound-voice" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></symbol>
    <symbol id="icon-sound-beep" viewBox="0 0 24 24"><path d="M7.58 4.08L6.15 2.65C3.75 4.48 2.17 7.3 2.03 10.5h2c.15-2.65 1.51-4.97 3.55-6.42zm12.39 6.42h2c-.15-3.2-1.73-6.02-4.12-7.85l-1.42 1.43c2.02 1.45 3.39 3.77 3.54 6.42zM18 11c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2v-5zm-6 11c.14 0 .27-.01.4-.04.65-.14 1.18-.58 1.44-1.18.1-.24.16-.49.16-.78h-4c0 .35.08.67.2.96.23.56.74.98 1.4 1.04h.4z"/></symbol>
    <symbol id="icon-sound-mute" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></symbol>
</svg>

<div class="bg-layer" id="bg-layer-dark"></div>
<div class="bg-layer" id="bg-layer-light"></div>

<div id="state-overlay"></div>

<div id="app-container">
    <canvas id="confetti-canvas"></canvas>

    <div id="home-screen" class="screen">
        <div class="header">
            <div class="app-title">FitLoop</div>
            <div class="header-actions">
                <div class="btn-pill btn-icon-only" onclick="App.toggleTheme()" id="btn-theme-toggle">
                    <svg class="icon-svg" style="width:20px;height:20px;"><use href="#icon-theme-dark" id="icon-theme-use"></use></svg>
                </div>
                <div class="btn-pill" onclick="App.openLangModal()">
                    <svg class="icon-svg" style="width:18px;height:18px;"><use href="#icon-lang"></use></svg>
                    <span data-i18n="btn_lang_text">EN</span>
                </div>
            </div>
        </div>

        <div class="card-grid">
            <div class="mode-card" id="card-tabata" style="--card-color: #FF3B30;" onclick="App.selectMode('tabata')">
                <div class="card-icon-box"><svg class="icon-lg"><use href="#icon-tabata"></use></svg></div>
                <div class="card-text-box"><div class="card-title" data-i18n="mode_tabata_title">Tabata</div><div class="card-desc" data-i18n="mode_tabata_desc">20s Work / 10s Rest</div><div class="resume-badge" data-i18n="status_paused">PAUSED</div></div>
            </div>
            <div class="mode-card" id="card-hiit" style="--card-color: #FF9F0A;" onclick="App.selectMode('hiit')">
                <div class="card-icon-box"><svg class="icon-lg"><use href="#icon-hiit"></use></svg></div>
                <div class="card-text-box"><div class="card-title" data-i18n="mode_hiit_title">HIIT</div><div class="card-desc" data-i18n="mode_hiit_desc">High Intensity Intervals</div><div class="resume-badge" data-i18n="status_paused">PAUSED</div></div>
            </div>
            <div class="mode-card" id="card-emom" style="--card-color: #30D158;" onclick="App.selectMode('emom')">
                <div class="card-icon-box"><svg class="icon-lg"><use href="#icon-emom"></use></svg></div>
                <div class="card-text-box"><div class="card-title" data-i18n="mode_emom_title">EMOM</div><div class="card-desc" data-i18n="mode_emom_desc">Every Minute on the Minute</div><div class="resume-badge" data-i18n="status_paused">PAUSED</div></div>
            </div>
            <div class="mode-card" id="card-gym" style="--card-color: #0A84FF;" onclick="App.selectMode('gym')">
                <div class="card-icon-box"><svg class="icon-lg"><use href="#icon-gym"></use></svg></div>
                <div class="card-text-box"><div class="card-title" data-i18n="mode_gym_title">Gym / Weights</div><div class="card-desc" data-i18n="mode_gym_desc">Sets & Rest Timer</div><div class="resume-badge" data-i18n="status_paused">PAUSED</div></div>
            </div>
            <div class="mode-card card-wide" id="card-jog" style="--card-color: #BF5AF2;" onclick="App.selectMode('jog')">
                <div class="card-icon-box"><svg class="icon-lg"><use href="#icon-jog"></use></svg></div>
                <div class="card-text-box"><div class="card-title" data-i18n="mode_jog_title">Slow Jog</div><div class="card-desc" data-i18n="mode_jog_desc">180 BPM Pacing</div><div class="resume-badge" data-i18n="status_paused">PAUSED</div></div>
            </div>
        </div>
    </div>

    <div id="timer-screen" class="screen hidden">
        <div class="top-bar">
            <button class="btn-back" id="btnBack" onclick="App.goBack()">
                <svg class="icon-svg"><use href="#icon-back"></use></svg>
                <span data-i18n="btn_back">Back</span>
            </button>
            <div class="total-remain-badge" id="totalRemainDisplay">Total: 00:00</div>
            <button class="btn-back" style="justify-content: flex-end;" onclick="App.openInfoModal()">
                <svg class="icon-svg"><use href="#icon-info"></use></svg>
            </button>
        </div>

        <div class="timer-display">
            <svg class="timer-ring-svg" viewBox="0 0 360 360">
                <circle class="ring-bg" cx="180" cy="180" r="160" />
                <circle class="ring-progress" id="ringProgress" cx="180" cy="180" r="160" />
            </svg>
            <div id="metro-needle" class="metro-needle"></div>

            <div class="status-text" id="statusText">READY</div>
            <div class="timer-digits" id="timerDigits">00:00</div>
            
            <div class="timer-sub">
                <span id="roundsText">Set 1 / 8</span>
                <div id="bpmControls" class="bpm-controls hidden">
                    <div class="bpm-btn" id="btn-bpm-minus">âˆ’</div>
                    <div class="bpm-val"><span id="bpmDisplay">180</span><span class="bpm-label">BPM</span></div>
                    <div class="bpm-btn" id="btn-bpm-plus">+</div>
                </div>
            </div>
        </div>

        <div class="controls-wrapper">
            <div class="tools-row" id="toolsRow">
                <button class="tool-btn" onclick="App.toggleSoundMode()">
                    <div class="tool-icon-wrap" id="icon-sound"><svg class="icon-svg"><use href="#icon-sound-beep"></use></svg></div>
                    <span class="tool-label" id="text-sound" data-i18n="sound_beep">Beep</span>
                </button>
                
                <button class="tool-btn lockable" id="btn-warmup" onclick="App.toggleWarmupDirect()">
                    <div class="tool-icon-wrap"><svg class="icon-svg"><use href="#icon-warmup"></use></svg></div>
                    <span class="tool-label" id="text-warmup" data-i18n="btn_warmup_off">Warmup? (OFF)</span>
                </button>

                <button class="tool-btn hidden" id="btn-metronome" onclick="App.openMetronomeModal()">
                    <div class="tool-icon-wrap"><svg class="icon-svg"><use href="#icon-metronome"></use></svg></div>
                    <span class="tool-label" id="text-metronome">Wood</span>
                </button>

                <button class="tool-btn lockable" onclick="App.openSettings()">
                    <div class="tool-icon-wrap"><svg class="icon-svg"><use href="#icon-settings"></use></svg></div>
                    <span class="tool-label" data-i18n="btn_custom">Edit</span>
                </button>
            </div>

            <div class="main-actions">
                <button class="action-btn btn-stop" id="btnReset" onclick="App.resetTimer()">
                    <svg class="icon-svg" style="width:20px;height:20px;"><use href="#icon-stop"></use></svg>
                    <span data-i18n="btn_reset">End / Reset</span>
                </button>
                <button class="action-btn btn-play" id="actionBtn" onclick="App.toggleTimerState()">
                    <div id="play-icon-wrap"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="metro-modal" class="modal-overlay">
        <div class="modal-sheet">
            <div class="sheet-header"><div class="sheet-title" data-i18n="modal_sound_title">Metronome Sound</div><button class="sheet-close" onclick="App.closeMetronomeModal()" data-i18n="btn_done">Done</button></div>
            <div style="display:grid; gap:10px; padding-bottom:20px;">
                <div class="lang-opt" id="opt-mute" onclick="App.setMetronomeSound('mute')">ğŸ”• Mute</div>
                <div class="lang-opt" id="opt-woodblock" onclick="App.setMetronomeSound('woodblock')">ğŸªµ Woodblock</div>
                <div class="lang-opt" id="opt-digital" onclick="App.setMetronomeSound('digital')">âš¡ï¸ Digital</div>
                <div class="lang-opt" id="opt-kick" onclick="App.setMetronomeSound('kick')">ğŸ¥ Kick Drum</div>
                <div class="lang-opt" id="opt-click" onclick="App.setMetronomeSound('click')">âš™ï¸ Tick</div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-sheet">
            <div class="sheet-header"><div class="sheet-title" data-i18n="modal_settings_title">Settings</div><button class="sheet-close" onclick="App.closeSettings()" data-i18n="btn_done">Done</button></div>
            <div class="total-est-box" id="modalTotalTime">Total: 00:00</div>
            
            <div id="group-standard">
                <div style="margin-bottom:10px; color:var(--text-secondary); font-size:12px; font-weight:700;" data-i18n="group_prep">PREPARATION</div>
                <div class="setting-row"><span data-i18n="label_prep">Get Ready</span><div class="input-group"><input type="tel" class="nice-input" id="set-prep-min" data-group="set-prep"><span class="unit">m</span><input type="tel" class="nice-input" id="set-prep-sec" data-group="set-prep"><span class="unit">s</span></div></div>
                <div class="setting-row"><span data-i18n="label_warmup">Warmup</span><div class="input-group"><input type="tel" class="nice-input" id="set-warmup-min" data-group="set-warmup"><span class="unit">m</span><input type="tel" class="nice-input" id="set-warmup-sec" data-group="set-warmup"><span class="unit">s</span></div></div>
                <div style="margin-bottom:10px; margin-top:20px; color:var(--text-secondary); font-size:12px; font-weight:700;" data-i18n="group_work">WORKOUT</div>
                <div class="setting-row" id="row-work"><span data-i18n="label_work">Work</span><div class="input-group"><input type="tel" class="nice-input" id="set-work-min" data-group="set-work"><span class="unit">m</span><input type="tel" class="nice-input" id="set-work-sec" data-group="set-work"><span class="unit">s</span></div></div>
                <div class="setting-row"><span data-i18n="label_rest">Rest</span><div class="input-group"><input type="tel" class="nice-input" id="set-rest-min" data-group="set-rest"><span class="unit">m</span><input type="tel" class="nice-input" id="set-rest-sec" data-group="set-rest"><span class="unit">s</span></div></div>
                <div class="setting-row"><span data-i18n="label_rounds">Rounds</span><div class="input-group"><input type="tel" class="nice-input" id="set-rounds"></div></div>
            </div>

            <div id="group-jog" class="hidden">
                 <div style="margin-bottom:10px; color:var(--text-secondary); font-size:12px; font-weight:700;" data-i18n="group_prep">PREPARATION</div>
                 <div class="setting-row"><span data-i18n="label_prep">Get Ready</span><div class="input-group"><input type="tel" class="nice-input" id="set-jog-prep-min"><span class="unit">m</span><input type="tel" class="nice-input" id="set-jog-prep-sec"><span class="unit">s</span></div></div>
                 <div class="setting-row"><span data-i18n="label_warmup">Warmup</span><div class="input-group"><input type="tel" class="nice-input" id="set-jog-warmup-min"><span class="unit">m</span><input type="tel" class="nice-input" id="set-jog-warmup-sec"><span class="unit">s</span></div></div>
                 <div style="margin-bottom:10px; margin-top:20px; color:var(--text-secondary); font-size:12px; font-weight:700;" data-i18n="group_work">WORKOUT</div>
                 <div class="setting-row"><span data-i18n="label_duration">Jog Duration</span><div class="input-group"><input type="tel" class="nice-input" id="set-jog-min"><span class="unit">m</span></div></div>
            </div>

            <div style="text-align: center; margin-top: 30px;"><button onclick="App.restoreDefaults()" style="background:none; border:none; color: #ff453a; font-size:14px; cursor:pointer;" data-i18n="btn_restore">Reset Defaults</button></div>
        </div>
    </div>
    
    <div id="info-modal" class="modal-overlay"><div class="modal-sheet"><div class="sheet-header"><div class="sheet-title" id="info-title">About</div><button class="sheet-close" onclick="App.closeInfoModal()" data-i18n="btn_close">Close</button></div><div id="info-content"></div></div></div>
    <div id="lang-modal" class="modal-overlay"><div class="modal-sheet"><div class="sheet-header"><div class="sheet-title" data-i18n="modal_lang_title">Language</div><button class="sheet-close" onclick="App.closeLangModal()">X</button></div><div style="display:grid; gap:10px; padding-bottom:20px;"><div class="lang-opt" onclick="App.setLanguage('en')">English</div><div class="lang-opt" onclick="App.setLanguage('zh-TW')">ç¹é«”ä¸­æ–‡ (Traditional Chinese)</div><div class="lang-opt" onclick="App.setLanguage('zh-CN')">ç®€ä½“ä¸­æ–‡ (Simplified Chinese)</div><div class="lang-opt" onclick="App.setLanguage('ja')">æ—¥æœ¬èª (Japanese)</div><div class="lang-opt" onclick="App.setLanguage('ko')">í•œêµ­ì–´ (Korean)</div></div></div></div>
</div>

<script>
/**
 * FitLoop Pro - Fixed Version v4.9 (Physics Needle, Orange Warmup, Final Logic Fix)
 */
const App = (function() {
    'use strict';

    // --- 1. Audio Engine 2.0 (Precision Metronome) ---
    const AudioEngine = {
        ctx: null,
        nextNoteTime: 0.0,
        
        init: function() {
            if (!this.ctx) {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (Ctx) this.ctx = new Ctx();
            }
            this.resume();
        },
        resume: function() {
            if (this.ctx && this.ctx.state === 'suspended') {
                this.ctx.resume().catch(e => console.warn(e));
            }
        },
        play: function(freq, type, duration, vol, startTime = 0) {
            if (!this.ctx) return;
            const t = this.ctx.currentTime + startTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, t);
            gain.gain.setValueAtTime(vol, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start(t);
            osc.stop(t + duration);
        },
        // Synthesize Metronome Sounds
        playSynth: function(type, time) {
             if(!this.ctx || type === 'mute') return;
             const t = time || this.ctx.currentTime;
             
             if(type === 'digital') {
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 osc.frequency.setValueAtTime(1200, t);
                 osc.frequency.exponentialRampToValueAtTime(800, t + 0.05);
                 gain.gain.setValueAtTime(0.3, t);
                 gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                 osc.connect(gain); gain.connect(this.ctx.destination);
                 osc.start(t); osc.stop(t + 0.05);
             } 
             else if(type === 'kick') {
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 osc.frequency.setValueAtTime(150, t);
                 osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                 gain.gain.setValueAtTime(0.5, t);
                 gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                 osc.connect(gain); gain.connect(this.ctx.destination);
                 osc.start(t); osc.stop(t + 0.5);
             }
             else if(type === 'click') {
                 // [FIX] Changed to "Tick" (Quartz style) - High pitch sine
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 osc.frequency.setValueAtTime(1500, t); // High pitch
                 gain.gain.setValueAtTime(0.8, t);
                 gain.gain.exponentialRampToValueAtTime(0.01, t + 0.03); // Very short decay
                 osc.connect(gain); gain.connect(this.ctx.destination);
                 osc.start(t); osc.stop(t + 0.03);
             }
             else { // Woodblock (Default)
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 osc.frequency.setValueAtTime(800, t); 
                 gain.gain.setValueAtTime(0.5, t);
                 gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                 osc.connect(gain); gain.connect(this.ctx.destination);
                 osc.start(t); osc.stop(t + 0.05);
                 const osc2 = this.ctx.createOscillator();
                 const gain2 = this.ctx.createGain();
                 osc2.type = 'square';
                 osc2.frequency.setValueAtTime(1200, t); 
                 gain2.gain.setValueAtTime(0.1, t);
                 gain2.gain.exponentialRampToValueAtTime(0.01, t + 0.03);
                 osc2.connect(gain2); gain2.connect(this.ctx.destination);
                 osc2.start(t); osc2.stop(t + 0.03);
             }
        }
    };

    // --- 2. Translations ---
    const translations = {
        'en': {
            btn_lang_text: "EN", mode_tabata_title: "Tabata", mode_tabata_desc: "20s Work / 10s Rest", mode_hiit_title: "HIIT", mode_hiit_desc: "High Intensity Intervals", mode_emom_title: "EMOM", mode_emom_desc: "Every Minute on the Minute", mode_gym_title: "Gym / Weights", mode_gym_desc: "Sets & Rest Timer", mode_jog_title: "Slow Jog", mode_jog_desc: "180 BPM Pacing",
            btn_back: "Back", btn_start: "Start", btn_pause: "Pause", btn_resume: "Resume", btn_reset: "End / Reset", btn_warmup_on: "Warmup? (ON)", btn_warmup_off: "Warmup? (OFF)", btn_custom: "Edit", btn_done: "Done", btn_restore: "Reset Defaults", btn_close: "Close", 
            modal_settings_title: "Settings", modal_lang_title: "Language", modal_sound_title: "Metronome Sound",
            group_prep: "Preparation", group_work: "Workout", label_prep: "Get Ready", label_warmup: "Warmup", label_work: "Work", label_rest: "Rest", label_rounds: "Rounds", 
            label_duration: "Duration", label_total_remain: "Total Left", label_total_est: "Est. Total",
            sound_beep: "Beep", sound_voice: "Voice", sound_mute: "Mute", phase_prep: "GET READY", phase_warmup: "WARM UP", phase_work: "WORK", phase_gym_work: "WORKOUT", phase_rest: "REST", phase_gym_rest: "REST", phase_finish: "COMPLETE", phase_start_warmup: "Start Warmup", phase_start_work: "Start Work", phase_gym_start: "Start Training", phase_start_rest: "Rest Now", phase_finish_train: "Workout Complete", phase_jog: "KEEP PACE",
            status_paused: "TIMER PAUSED", 
            info_tabata: `<h3>Tabata Protocol</h3><p>20s all-out, 10s rest. 4 mins total.</p>`,
            info_hiit: `<h3>HIIT</h3><p>High-Intensity Interval Training. Burns calories fast.</p>`,
            info_emom: `<h3>EMOM</h3><p>Every Minute on the Minute. Finish task, rest remaining time.</p>`,
            info_gym: `<h3>Gym / Weights</h3><p>Focus on rest periods for Hypertrophy (60-90s) or Strength (3-5m).</p>`,
            info_jog: `<h3>Super Slow Jogging</h3><p>Run at a slow pace with high cadence (180 BPM).</p><ul><li><strong>Posture:</strong> Keep back straight, look forward.</li><li><strong>Landing:</strong> Land on forefoot.</li><li><strong>Niko Niko Pace:</strong> Smile and run comfortably!</li></ul>`
        },
        'zh-TW': {
            btn_lang_text: "ç¹ä¸­", mode_tabata_title: "Tabata ç‡ƒè„‚", mode_tabata_desc: "20ç§’é‹å‹• / 10ç§’ä¼‘æ¯", mode_hiit_title: "HIIT é–“æ­‡", mode_hiit_desc: "é«˜å¼·åº¦æœ‰æ°§å¾ªç’°", mode_emom_title: "EMOM æŒ‘æˆ°", mode_emom_desc: "æ¯åˆ†é˜æ•´é»å¾ªç’°", mode_gym_title: "é‡é‡è¨“ç·´", mode_gym_desc: "çµ„æ•¸èˆ‡ä¼‘æ¯è¨ˆæ™‚", mode_jog_title: "è¶…æ…¢è·‘", mode_jog_desc: "180 BPM ç¯€æ‹å™¨",
            btn_back: "è¿”å›", btn_start: "é–‹å§‹", btn_pause: "æš«åœ", btn_resume: "ç¹¼çºŒ", btn_reset: "çµæŸ / é‡ç½®", btn_warmup_on: "æš–èº«? (é–‹å•Ÿ)", btn_warmup_off: "æš–èº«? (é—œé–‰)", btn_custom: "è¨­å®š", btn_done: "å®Œæˆ", btn_restore: "é‚„åŸé è¨­", btn_close: "é—œé–‰", 
            modal_settings_title: "è¨“ç·´è¨­å®š", modal_lang_title: "èªè¨€é¸æ“‡", modal_sound_title: "ç¯€æ‹å™¨éŸ³è‰²",
            group_prep: "æº–å‚™éšæ®µ", group_work: "è¨“ç·´å…§å®¹", label_prep: "å€’æ•¸æº–å‚™", label_warmup: "æš–èº«æ™‚é–“", label_work: "é‹å‹•æ™‚é–“", label_rest: "ä¼‘æ¯æ™‚é–“", label_rounds: "ç¸½çµ„æ•¸", 
            label_duration: "ç›®æ¨™æ™‚é–“", label_total_remain: "å‰©é¤˜", label_total_est: "é ä¼°ç¸½æ™‚é•·",
            sound_beep: "éŸ³æ•ˆ", sound_voice: "èªéŸ³", sound_mute: "éœéŸ³", phase_prep: "æº–å‚™", phase_warmup: "æš–èº«", phase_work: "é‹å‹•", phase_gym_work: "è¨“ç·´ä¸­", phase_rest: "ä¼‘æ¯", phase_gym_rest: "ä¼‘æ¯", phase_finish: "å®Œæˆ", phase_start_warmup: "é–‹å§‹æš–èº«", phase_start_work: "é–‹å§‹é‹å‹•", phase_gym_start: "é–‹å§‹è¨“ç·´", phase_start_rest: "ä¼‘æ¯ä¸€ä¸‹", phase_finish_train: "è¨“ç·´çµæŸ", phase_jog: "ä¿æŒç¯€å¥",
            status_paused: "è¨ˆæ™‚æš«åœ",
            info_tabata: `<h3>Tabata è¨“ç·´æ³•</h3><p>20ç§’æ¥µé™è¡åˆº + 10ç§’ä¼‘æ¯ï¼Œå…± 4 åˆ†é˜ã€‚</p>`,
            info_hiit: `<h3>HIIT é«˜å¼·åº¦é–“æ­‡</h3><p>é€éåŠ‡çƒˆå¿ƒç‡æ³¢å‹•ï¼Œå¼•ç™¼å¾Œç‡ƒæ•ˆæ‡‰ã€‚</p>`,
            info_emom: `<h3>EMOM åˆ†é˜è¨“ç·´</h3><p>æ¯åˆ†é˜æ•´é»é–‹å§‹åšå‹•ä½œï¼Œåšå®Œå‰©ä¸‹çš„æ™‚é–“å³ç‚ºä¼‘æ¯ã€‚</p>`,
            info_gym: `<h3>é‡é‡è¨“ç·´è¨ˆæ™‚</h3><p>é‡é»åœ¨æ–¼çµ„é–“ä¼‘æ¯ã€‚è‚Œè‚¥å¤§ä¼‘60-90ç§’ï¼Œæœ€å¤§è‚ŒåŠ›ä¼‘3-5åˆ†ã€‚</p>`,
            info_jog: `<h3>è¶…æ…¢è·‘</h3><p>ä»¥è¼•é¬†çš„é€Ÿåº¦æ­é…é«˜æ­¥é » (180 BPM) è·‘æ­¥ã€‚</p><ul><li><strong>å§¿å‹¢ï¼š</strong>èƒŒéƒ¨æ‰“ç›´ï¼Œè¦–ç·šå‘å‰ï¼Œä¿æŒå¾®ç¬‘ã€‚</li><li><strong>è½åœ°ï¼š</strong>å‰è…³æŒå…ˆè‘—åœ°ï¼ˆé¿å…è…³è·Ÿè¡æ“Šï¼‰ã€‚</li><li><strong>å„ªé»ï¼š</strong>ä½è¡æ“Šã€ä¸ç´¯ã€ç‡ƒè„‚æ•ˆç‡é«˜ã€‚</li></ul>`
        },
        'zh-CN': {
            btn_lang_text: "ç®€ä¸­", mode_tabata_title: "Tabata ç‡ƒè„‚", mode_tabata_desc: "20ç§’è¿åŠ¨ / 10ç§’ä¼‘æ¯", mode_hiit_title: "HIIT é—´æ­‡", mode_hiit_desc: "é«˜å¼ºåº¦æœ‰æ°§å¾ªç¯", mode_emom_title: "EMOM æŒ‘æˆ˜", mode_emom_desc: "æ¯åˆ†é’Ÿæ•´ç‚¹å¾ªç¯", mode_gym_title: "é‡é‡è®­ç»ƒ", mode_gym_desc: "ç»„æ•°ä¸ä¼‘æ¯è®¡æ—¶", mode_jog_title: "è¶…æ…¢è·‘", mode_jog_desc: "180 BPM èŠ‚æ‹å™¨",
            btn_back: "è¿”å›", btn_start: "å¼€å§‹", btn_pause: "æš‚åœ", btn_resume: "ç»§ç»­", btn_reset: "ç»“æŸ / é‡ç½®", btn_warmup_on: "çƒ­èº«? (å¼€å¯)", btn_warmup_off: "çƒ­èº«? (å…³é—­)", btn_custom: "è®¾å®š", btn_done: "å®Œæˆ", btn_restore: "è¿˜åŸé»˜è®¤", btn_close: "å…³é—­", 
            modal_settings_title: "è®­ç»ƒè®¾å®š", modal_lang_title: "è¯­è¨€é€‰æ‹©", modal_sound_title: "èŠ‚æ‹å™¨éŸ³è‰²",
            group_prep: "å‡†å¤‡é˜¶æ®µ", group_work: "è®­ç»ƒå†…å®¹", label_prep: "å€’æ•°å‡†å¤‡", label_warmup: "çƒ­èº«æ—¶é—´", label_work: "è¿åŠ¨æ—¶é—´", label_rest: "ä¼‘æ¯æ—¶é—´", label_rounds: "æ€»ç»„æ•°", 
            label_duration: "ç›®æ ‡æ—¶é—´", label_total_remain: "å‰©ä½™", label_total_est: "é¢„ä¼°æ€»æ—¶é•¿",
            sound_beep: "éŸ³æ•ˆ", sound_voice: "äººå£°", sound_mute: "é™éŸ³", phase_prep: "å‡†å¤‡", phase_warmup: "çƒ­èº«", phase_work: "è¿åŠ¨", phase_gym_work: "è®­ç»ƒä¸­", phase_rest: "ä¼‘æ¯", phase_gym_rest: "ä¼‘æ¯", phase_finish: "å®Œæˆ", phase_start_warmup: "å¼€å§‹çƒ­èº«", phase_start_work: "å¼€å§‹è¿åŠ¨", phase_gym_start: "å¼€å§‹è®­ç»ƒ", phase_start_rest: "ä¼‘æ¯ä¸€ä¸‹", phase_finish_train: "è®­ç»ƒç»“æŸ", phase_jog: "ä¿æŒèŠ‚å¥",
            status_paused: "è®¡æ—¶æš‚åœ",
            info_tabata: `<h3>Tabata è®­ç»ƒæ³•</h3><p>20ç§’æé™å†²åˆº + 10ç§’ä¼‘æ¯ï¼Œå…± 4 åˆ†é’Ÿã€‚</p>`,
            info_hiit: `<h3>HIIT é«˜å¼ºåº¦é—´æ­‡</h3><p>é€šè¿‡å‰§çƒˆå¿ƒç‡æ³¢åŠ¨ï¼Œå¼•å‘åç‡ƒæ•ˆåº”ã€‚</p>`,
            info_emom: `<h3>EMOM åˆ†é’Ÿè®­ç»ƒ</h3><p>æ¯åˆ†é’Ÿæ•´ç‚¹å¼€å§‹åšåŠ¨ä½œï¼Œåšå®Œå‰©ä¸‹çš„æ—¶é—´å³ä¸ºä¼‘æ¯ã€‚</p>`,
            info_gym: `<h3>é‡é‡è®­ç»ƒè®¡æ—¶</h3><p>é‡ç‚¹åœ¨äºç»„é—´ä¼‘æ¯ã€‚</p>`,
            info_jog: `<h3>è¶…æ…¢è·‘</h3><p>ä»¥è½»æ¾çš„é€Ÿåº¦æ­é…é«˜æ­¥é¢‘ (180 BPM) è·‘æ­¥ã€‚</p><ul><li><strong>å§¿åŠ¿ï¼š</strong>èƒŒéƒ¨æ‰“ç›´ï¼Œè§†çº¿å‘å‰ï¼Œä¿æŒå¾®ç¬‘ã€‚</li><li><strong>è½åœ°ï¼š</strong>å‰è„šæŒå…ˆç€åœ°ã€‚</li></ul>`
        },
        'ja': { 
            btn_lang_text: "JP", mode_tabata_title: "ã‚¿ãƒã‚¿å¼", mode_tabata_desc: "20ç§’é‹å‹• / 10ç§’ä¼‘æ†©", mode_hiit_title: "HIIT", mode_hiit_desc: "é«˜å¼·åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«", mode_emom_title: "EMOM", mode_emom_desc: "1åˆ†é–“ã”ã¨ã®ã‚»ãƒƒãƒˆ", mode_gym_title: "ç­‹ãƒˆãƒ¬", mode_gym_desc: "ã‚»ãƒƒãƒˆï¼†ä¼‘æ†©ã‚¿ã‚¤ãƒãƒ¼", mode_jog_title: "ã‚¹ãƒ­ãƒ¼ã‚¸ãƒ§ã‚°", mode_jog_desc: "180 BPM ãƒšãƒ¼ã‚·ãƒ³ã‚°",
            btn_back: "æˆ»ã‚‹", btn_start: "é–‹å§‹", btn_pause: "ä¸€æ™‚åœæ­¢", btn_resume: "å†é–‹", btn_reset: "çµ‚äº† / ãƒªã‚»ãƒƒãƒˆ", btn_warmup_on: "æº–å‚™é‹å‹•? (ã‚ªãƒ³)", btn_warmup_off: "æº–å‚™é‹å‹•? (ã‚ªãƒ•)", btn_custom: "è¨­å®š", btn_done: "å®Œäº†", btn_restore: "åˆæœŸåŒ–", btn_close: "é–‰ã˜ã‚‹", 
            modal_settings_title: "è¨­å®š", modal_lang_title: "è¨€èª", modal_sound_title: "ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ éŸ³",
            group_prep: "æº–å‚™", group_work: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", label_prep: "æº–å‚™æ™‚é–“", label_warmup: "æº–å‚™é‹å‹•", label_work: "é‹å‹•", label_rest: "ä¼‘æ†©", label_rounds: "ã‚»ãƒƒãƒˆæ•°", 
            label_duration: "ç›®æ¨™æ™‚é–“", label_total_remain: "æ®‹ã‚Šæ™‚é–“", label_total_est: "åˆè¨ˆæ™‚é–“",
            sound_beep: "ãƒ“ãƒ¼ãƒ—éŸ³", sound_voice: "éŸ³å£°", sound_mute: "ãƒŸãƒ¥ãƒ¼ãƒˆ", phase_prep: "æº–å‚™", phase_warmup: "æº–å‚™é‹å‹•", phase_work: "é‹å‹•ä¸­", phase_gym_work: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°", phase_rest: "ä¼‘æ†©", phase_gym_rest: "ä¼‘æ†©", phase_finish: "å®Œäº†", phase_start_warmup: "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—é–‹å§‹", phase_start_work: "é‹å‹•é–‹å§‹", phase_gym_start: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹", phase_start_rest: "ä¼‘æ†©", phase_finish_train: "çµ‚äº†", phase_jog: "ãƒšãƒ¼ã‚¹ç¶­æŒ",
            status_paused: "ä¸€æ™‚åœæ­¢ä¸­",
            info_tabata: `<h3>ã‚¿ãƒã‚¿ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«</h3><p>20ç§’å…¨åŠ›+10ç§’ä¼‘æ†©ã€‚</p>`,
            info_hiit: `<h3>HIIT</h3><p>é«˜å¼·åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚</p>`,
            info_emom: `<h3>EMOM</h3><p>1åˆ†é–“ã”ã¨ã«æ±ºã¾ã£ãŸã‚¿ã‚¹ã‚¯ã‚’è¡Œã†ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚</p>`,
            info_gym: `<h3>ç­‹ãƒˆãƒ¬ä¼‘æ†©ã‚¿ã‚¤ãƒãƒ¼</h3><p>ã‚»ãƒƒãƒˆé–“ã®ä¼‘æ†©ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>`,
            info_jog: `<h3>ã‚¹ãƒ­ãƒ¼ã‚¸ãƒ§ã‚°</h3><p>ãƒ‹ã‚³ãƒ‹ã‚³ãƒšãƒ¼ã‚¹ã§èµ°ã‚‹é‹å‹•æ³•ã€‚</p><ul><li><strong>180 BPM:</strong> å°åˆ»ã¿ãªãƒªã‚ºãƒ ã§é–¢ç¯€ã¸ã®è² æ‹…ã‚’æ¸›ã‚‰ã—ã¾ã™ã€‚</li><li><strong>ãƒ•ã‚©ã‚¢ãƒ•ãƒƒãƒˆ:</strong> è¶³ã®æŒ‡ã®ä»˜ã‘æ ¹ã‚ãŸã‚Šã§ç€åœ°ã—ã¾ã—ã‚‡ã†ã€‚</li></ul>`
        },
        'ko': { 
            btn_lang_text: "KR", mode_tabata_title: "íƒ€ë°”íƒ€", mode_tabata_desc: "20ì´ˆ ìš´ë™ / 10ì´ˆ íœ´ì‹", mode_hiit_title: "HIIT", mode_hiit_desc: "ê³ ê°•ë„ ì¸í„°ë²Œ", mode_emom_title: "EMOM", mode_emom_desc: "1ë¶„ ë‹¨ìœ„ ë°˜ë³µ", mode_gym_title: "ì›¨ì´íŠ¸", mode_gym_desc: "ì„¸íŠ¸ ë° íœ´ì‹", mode_jog_title: "ìŠ¬ë¡œìš° ì¡°ê¹…", mode_jog_desc: "180 BPM í˜ì´ì‹±",
            btn_back: "ë’¤ë¡œ", btn_start: "ì‹œì‘", btn_pause: "ì¼ì‹œì •ì§€", btn_resume: "ê³„ì†", btn_reset: "ì¢…ë£Œ / ì´ˆê¸°í™”", btn_warmup_on: "ì›œì—…? (ì¼œì§)", btn_warmup_off: "ì›œì—…? (êº¼ì§)", btn_custom: "ì„¤ì •", btn_done: "ì™„ë£Œ", btn_restore: "ì´ˆê¸°í™”", btn_close: "ë‹«ê¸°", 
            modal_settings_title: "ì„¤ì •", modal_lang_title: "ì–¸ì–´", modal_sound_title: "ë©”íŠ¸ë¡œë†ˆ ì†Œë¦¬",
            group_prep: "ì¤€ë¹„", group_work: "ìš´ë™", label_prep: "ì¤€ë¹„ ì‹œê°„", label_warmup: "ì›œì—…", label_work: "ìš´ë™", label_rest: "íœ´ì‹", label_rounds: "ì„¸íŠ¸ ìˆ˜", 
            label_duration: "ëª©í‘œ ì‹œê°„", label_total_remain: "ë‚¨ì€ ì‹œê°„", label_total_est: "ì´ ì‹œê°„",
            sound_beep: "ë¹„í”„ìŒ", sound_voice: "ìŒì„±", sound_mute: "ë¬´ìŒ", phase_prep: "ì¤€ë¹„", phase_warmup: "ì›œì—…", phase_work: "ìš´ë™", phase_gym_work: "íŠ¸ë ˆì´ë‹", phase_rest: "íœ´ì‹", phase_gym_rest: "íœ´ì‹", phase_finish: "ì™„ë£Œ", phase_start_warmup: "ì›œì—… ì‹œì‘", phase_start_work: "ìš´ë™ ì‹œì‘", phase_gym_start: "íŠ¸ë ˆì´ë‹ ì‹œì‘", phase_start_rest: "íœ´ì‹", phase_finish_train: "ìš´ë™ ì¢…ë£Œ", phase_jog: "í˜ì´ìŠ¤ ìœ ì§€",
            status_paused: "ì¼ì‹œì •ì§€",
            info_tabata: `<h3>íƒ€ë°”íƒ€</h3><p>20ì´ˆ ìš´ë™ + 10ì´ˆ íœ´ì‹.</p>`,
            info_hiit: `<h3>HIIT</h3><p>ê³ ê°•ë„ ì¸í„°ë²Œ íŠ¸ë ˆì´ë‹.</p>`,
            info_emom: `<h3>EMOM</h3><p>1ë¶„ë§ˆë‹¤ ì •í•´ì§„ ë™ì‘ ìˆ˜í–‰.</p>`,
            info_gym: `<h3>ì›¨ì´íŠ¸ íƒ€ì´ë¨¸</h3><p>ì„¸íŠ¸ ê°„ íœ´ì‹ ì‹œê°„ ê´€ë¦¬.</p>`,
            info_jog: `<h3>ìŠ¬ë¡œìš° ì¡°ê¹…</h3><p>ì˜†ì‚¬ëŒê³¼ ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ì†ë„ë¡œ ë‹¬ë¦¬ì„¸ìš”.</p><ul><li><strong>180 BPM:</strong> ë¶€ìƒ ë°©ì§€ë¥¼ ìœ„í•œ ìµœì ì˜ ì¼€ì´ë˜ìŠ¤.</li><li><strong>ë¯¸ë“œí’‹/í¬ì–´í’‹:</strong> ë°œë°”ë‹¥ ì „ì²´ë‚˜ ì•ë¶€ë¶„ìœ¼ë¡œ ì°©ì§€í•˜ì„¸ìš”.</li></ul>`
        }
    };

    // --- 3. State & Config ---
    let currentLang = localStorage.getItem('fitloopLang');
    if (!currentLang) {
        const sysLang = navigator.language.toLowerCase();
        if (sysLang.includes('zh')) currentLang = (sysLang.includes('tw') || sysLang.includes('hk')) ? 'zh-TW' : 'zh-CN';
        else if (sysLang.includes('ja')) currentLang = 'ja';
        else if (sysLang.includes('ko')) currentLang = 'ko';
        else currentLang = 'en';
    }

    let currentTheme = localStorage.getItem('fitloopTheme') || 'dark';
    
    // Global Sound State (Persistence)
    let soundMode = localStorage.getItem('fitloopSoundMode') || 'beep'; 

    const defaultPresets = {
        tabata: { name: "Tabata", work: 20, rest: 10, rounds: 8, prep: 5, warmupOn: false, warmupTime: 60, type: 'interval', color: '#FF3B30' },
        hiit:   { name: "HIIT",   work: 30, rest: 30, rounds: 10, prep: 5, warmupOn: true, warmupTime: 120, type: 'interval', color: '#FF9F0A' },
        emom:   { name: "EMOM",   work: 60, rest: 0, rounds: 10, prep: 5, warmupOn: false, warmupTime: 60, type: 'loop', color: '#30D158' },
        gym:    { name: "Gym",    work: 40, rest: 90, rounds: 5, prep: 5, warmupOn: false, warmupTime: 0, type: 'interval', color: '#0A84FF' },
        // [FIX] Independent variables for jog prep and warmup
        jog:    { name: "Jog",    duration: 1800, prep: 5, warmupOn: true, warmupTime: 180, bpm: 180, soundType: 'woodblock', type: 'continuous', color: '#BF5AF2' }
    };

    let presets = JSON.parse(localStorage.getItem('fitloopSettings')) || JSON.parse(JSON.stringify(defaultPresets));
    // Migration for existing users
    if(!presets.jog) { presets.jog = JSON.parse(JSON.stringify(defaultPresets.jog)); }

    // Ensure numbers
    for(let k in presets) {
        if(k === 'jog') {
             presets[k].duration = Number(presets[k].duration);
             // Ensure jog specific variables exist, if not migrate them
             if(presets[k].prep === undefined) presets[k].prep = 5;
             if(presets[k].warmupTime === undefined) presets[k].warmupTime = 180;
             
             presets[k].prep = Number(presets[k].prep);
             presets[k].warmupTime = Number(presets[k].warmupTime);
             presets[k].bpm = Number(presets[k].bpm);
        } else {
             presets[k].work = Number(presets[k].work);
             presets[k].rest = Number(presets[k].rest);
             presets[k].rounds = Number(presets[k].rounds);
             presets[k].prep = Number(presets[k].prep);
             presets[k].warmupTime = Number(presets[k].warmupTime);
        }
    }

    let currentMode = 'tabata';
    let wakeLock = null;
    let confettiActive = false;
    let lastToggleTime = 0;
    let lastThemeToggleTime = 0;

    // [FIX] needlePhase state added
    let state = { phase: 'idle', timeLeft: 0, currentRound: 1, isRunning: false, timerId: null, endTime: 0, remainingMs: 0, phaseDuration: 0, nextNoteTime: 0, needlePhase: 0 };
    let totalRemainingSeconds = 0;
    let ringFrameId = null;
    let lastFrameTime = 0;

    const UI = {};

    // --- 4. Core Functions ---
    function init() {
        const ids = [
            'app-container', 'home-screen', 'timer-screen', 'confetti-canvas',
            'btnBack', 'totalRemainDisplay', 'ringProgress', 'statusText', 'timerDigits', 'roundsText',
            'btnReset', 'actionBtn', 'play-icon-wrap', 'btn-warmup', 'text-warmup', 'text-sound', 'icon-sound', 
            'btn-metronome', 'text-metronome', 'toolsRow', 'metro-needle',
            'settings-modal', 'info-modal', 'lang-modal', 'metro-modal', 'info-title', 'info-content', 'modalTotalTime',
            'set-prep-min', 'set-prep-sec', 'set-warmup-min', 'set-warmup-sec', 
            'set-work-min', 'set-work-sec', 'set-rest-min', 'set-rest-sec', 'set-rounds', 'row-work',
            'icon-theme-use', 'state-overlay',
            'card-tabata', 'card-hiit', 'card-emom', 'card-gym', 'card-jog',
            'bg-layer-dark', 'bg-layer-light',
            'group-standard', 'group-jog', 'set-jog-min', 
            'set-jog-prep-min', 'set-jog-prep-sec', 'set-jog-warmup-min', 'set-jog-warmup-sec',
            'bpmControls', 'bpmDisplay', 'btn-bpm-plus', 'btn-bpm-minus'
        ];
        ids.forEach(id => UI[id] = document.getElementById(id));
        
        document.querySelectorAll('.modal-overlay').forEach(el => {
            el.addEventListener('click', function(e) {
                if (e.target === this) {
                    if(this.id === 'settings-modal') closeSettings();
                    if(this.id === 'info-modal') closeInfoModal();
                    if(this.id === 'lang-modal') closeLangModal();
                    if(this.id === 'metro-modal') closeMetronomeModal();
                }
            });
        });

        document.querySelectorAll('.nice-input').forEach(el => {
            el.addEventListener('input', function() { 
                this.value = this.value.replace(/[^0-9]/g, ''); 
            });
            el.addEventListener('blur', function() { validateInput(this); liveUpdateTotal(); });
        });

        // Rapid Fire BPM Controls
        initRapidFire(UI['btn-bpm-minus'], -1);
        initRapidFire(UI['btn-bpm-plus'], 1);

        document.body.addEventListener('touchstart', function() { AudioEngine.resume(); }, { once: true });
        document.body.addEventListener('click', function() { AudioEngine.resume(); }, { once: true });

        document.addEventListener('visibilitychange', handleVisibilityChange);

        applyTheme();
        applyLanguage();
        updateSafeguards();
        updateHomeIndicators(); 
    }

    // --- Rapid Fire Logic (Dual Speed) ---
    function initRapidFire(btn, direction) {
        let timeout, interval;
        let startTime;

        const action = () => {
            const now = Date.now();
            const elapsed = now - startTime;
            // Tier 2 speed (Fast) after 1.5s hold, else Tier 1 (Slow)
            const amount = (elapsed > 1500) ? 5 : 1;
            App.adjustBPM(direction * amount);
        };
        
        const start = (e) => {
            e.preventDefault();
            startTime = Date.now();
            App.adjustBPM(direction); // Immediate click
            // Start repeating after delay
            timeout = setTimeout(() => {
                interval = setInterval(action, 100);
            }, 500);
        };
        const stop = (e) => {
            e.preventDefault();
            clearTimeout(timeout);
            clearInterval(interval);
        };

        btn.addEventListener('mousedown', start);
        btn.addEventListener('touchstart', start);
        btn.addEventListener('mouseup', stop);
        btn.addEventListener('mouseleave', stop);
        btn.addEventListener('touchend', stop);
    }

    function t(key) { return translations[currentLang][key] || key; }

    async function toggleWakeLock(active) {
        if ('wakeLock' in navigator) {
            try {
                if (active && !wakeLock && document.visibilityState === 'visible') {
                    wakeLock = await navigator.wakeLock.request('screen');
                } else if (!active && wakeLock) {
                    await wakeLock.release(); wakeLock = null;
                }
            } catch (err) { console.warn('Wake Lock:', err); }
        }
    }

    function handleVisibilityChange() {
        if (document.visibilityState === 'visible') {
            if (state.isRunning) toggleWakeLock(true);
            AudioEngine.resume();
        } else {
            wakeLock = null;
        }
    }

    function toggleTheme() {
        const now = Date.now();
        if (now - lastThemeToggleTime < 500) return; 
        lastThemeToggleTime = now;

        playClick();
        currentTheme = (currentTheme === 'dark') ? 'light' : 'dark';
        localStorage.setItem('fitloopTheme', currentTheme);
        applyTheme();
    }

    function applyTheme() {
        document.body.setAttribute('data-theme', currentTheme);
        UI['icon-theme-use'].setAttribute('href', currentTheme === 'dark' ? '#icon-theme-dark' : '#icon-theme-light');
        if(state.phase === 'idle') updateDisplay();
    }

    function openLangModal() { playClick(); UI['lang-modal'].classList.add('open'); }
    function closeLangModal() { playClick(); UI['lang-modal'].classList.remove('open'); }
    function setLanguage(lang) {
        currentLang = lang; localStorage.setItem('fitloopLang', lang);
        applyLanguage(); closeLangModal();
    }
    function applyLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(t(key)) el.innerText = t(key);
        });
        updateSoundUI(); updateWarmupUI(); updateActionBtnState(); updateMetronomeUI();
        if(state.phase === 'idle') updateDisplay();
    }

    function openInfoModal() {
        playClick();
        if(currentMode === 'jog') { UI['info-title'].innerText = t('mode_jog_title'); UI['info-content'].innerHTML = t('info_jog'); }
        else if(currentMode === 'tabata') { UI['info-title'].innerText = t('mode_tabata_title'); UI['info-content'].innerHTML = t('info_tabata'); }
        else if(currentMode === 'hiit') { UI['info-title'].innerText = t('mode_hiit_title'); UI['info-content'].innerHTML = t('info_hiit'); }
        else if(currentMode === 'emom') { UI['info-title'].innerText = t('mode_emom_title'); UI['info-content'].innerHTML = t('info_emom'); }
        else if(currentMode === 'gym') { UI['info-title'].innerText = t('mode_gym_title'); UI['info-content'].innerHTML = t('info_gym'); }
        UI['info-modal'].classList.add('open');
    }
    function closeInfoModal() { playClick(); UI['info-modal'].classList.remove('open'); }

    // --- SAVE / LOAD SESSIONS ---
    function getSessions() {
        const stored = localStorage.getItem('fitloop_sessions_v1');
        return stored ? JSON.parse(stored) : {};
    }

    function saveSession(mode) {
        if(state.phase === 'idle' || state.phase === 'finished') return;
        const sessions = getSessions();
        sessions[mode] = { state: state };
        localStorage.setItem('fitloop_sessions_v1', JSON.stringify(sessions));
        updateHomeIndicators();
    }

    function loadSession(mode) {
        const sessions = getSessions();
        if(sessions[mode]) {
            const data = sessions[mode];
            state = data.state;
            state.isRunning = false; 
            state.timerId = null;
            state.endTime = 0; 
            if(state.remainingMs <= 0) state.remainingMs = state.timeLeft * 1000;
            return true;
        }
        return false;
    }

    function clearSession(mode) {
        const sessions = getSessions();
        if(sessions[mode]) {
            delete sessions[mode];
            localStorage.setItem('fitloop_sessions_v1', JSON.stringify(sessions));
        }
        updateHomeIndicators();
    }

    function updateHomeIndicators() {
        const sessions = getSessions();
        const modes = ['tabata', 'hiit', 'emom', 'gym', 'jog'];
        modes.forEach(m => {
            const card = UI['card-' + m];
            if(sessions[m]) card.classList.add('has-save');
            else card.classList.remove('has-save');
        });
    }

    // --- Mode Selection & Logic ---
    function selectMode(mode) {
        playClick();
        currentMode = mode;
        UI['home-screen'].classList.add('hidden');
        UI['timer-screen'].classList.remove('hidden');
        const color = presets[mode].color || '#fff';
        document.documentElement.style.setProperty('--accent-color', color);
        
        // Toggle UI based on mode
        if(currentMode === 'jog') {
            UI['roundsText'].classList.add('hidden');
            UI['bpmControls'].classList.remove('hidden');
            UI['bpmDisplay'].innerText = presets.jog.bpm;
            UI['btn-metronome'].classList.remove('hidden');
            UI['toolsRow'].style.display = 'grid';
            UI['toolsRow'].style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
        } else {
            UI['roundsText'].classList.remove('hidden');
            UI['bpmControls'].classList.add('hidden');
            UI['btn-metronome'].classList.add('hidden');
            UI['toolsRow'].style.display = 'flex';
        }

        updateSoundUI(); updateWarmupUI(); updateMetronomeUI();
        
        if(loadSession(mode)) {
            updateSafeguards();
            updateActionBtnState();
            updateDisplay();
            UI['statusText'].innerText = t('status_paused');
            if(currentMode === 'jog') UI['bpmDisplay'].innerText = presets.jog.bpm;
        } else {
            resetTimer(false);
        }
    }

    function goBack() {
        playClick();
        if(state.phase !== 'idle' && state.phase !== 'finished') {
            clearInterval(state.timerId); 
            state.isRunning = false; 
            if(state.endTime > 0) state.remainingMs = Math.max(0, state.endTime - Date.now());
            saveSession(currentMode); 
        }
        clearInterval(state.timerId); state.isRunning = false; toggleWakeLock(false);
        cancelAnimationFrame(ringFrameId);
        UI['timer-screen'].classList.add('hidden');
        UI['home-screen'].classList.remove('hidden');
        UI['state-overlay'].style.backgroundColor = 'var(--state-bg-idle)';
        UI['metro-needle'].classList.remove('active');
        stopConfetti();
    }

    function calcTotalDuration(p) {
        let total = 0;
        if(currentMode === 'jog') {
            total += Number(p.prep);
            if(p.warmupOn) total += Number(p.warmupTime);
            total += Number(p.duration);
        } else {
            total = Number(p.prep);
            if(p.warmupOn) total += Number(p.warmupTime);
            if(p.type === 'countdown') {
                total += Number(p.rest);
            } else {
                const work = Number(p.work);
                const rest = Number(p.rest);
                const rounds = Number(p.rounds);
                total += (work + rest) * rounds;
            }
        }
        return total;
    }

    function resetTimer(playAudio = true) {
        if(state.isRunning) return; 

        if(playAudio) playClick();
        clearInterval(state.timerId);
        cancelAnimationFrame(ringFrameId);
        state.isRunning = false; state.currentRound = 1; state.phase = 'idle'; state.remainingMs = 0;
        
        clearSession(currentMode);
        toggleWakeLock(false);
        stopConfetti();
        UI['metro-needle'].classList.remove('active');
        
        const p = presets[currentMode];
        
        if(currentMode === 'jog') {
             p.prep = Number(p.prep); p.warmupTime = Number(p.warmupTime);
             p.duration = Number(p.duration);
             UI['bpmDisplay'].innerText = p.bpm;
             
             if (p.prep > 0) { state.timeLeft = p.prep; state.phaseDuration = p.prep; }
             else if (p.warmupOn) { state.timeLeft = p.warmupTime; state.phaseDuration = p.warmupTime; }
             else { state.timeLeft = p.duration; state.phaseDuration = p.duration; }
             
        } else {
            p.prep = Number(p.prep); p.warmupTime = Number(p.warmupTime);
            p.work = Number(p.work); p.rest = Number(p.rest);
            
            if (p.prep > 0) { state.timeLeft = p.prep; state.phaseDuration = p.prep; }
            else if (p.warmupOn) { state.timeLeft = p.warmupTime; state.phaseDuration = p.warmupTime; }
            else { state.timeLeft = p.work; state.phaseDuration = p.work; }
        }

        totalRemainingSeconds = calcTotalDuration(p);

        updateSafeguards(); updateActionBtnState(); updateDisplay();
    }

    // --- Metronome Scheduler ---
    function scheduleMetronome() {
        if(!state.isRunning || currentMode !== 'jog' || state.phase !== 'work') return;

        const lookahead = 0.1; 
        const p = presets['jog'];
        
        // If sound is ON (not mute)
        if (p.soundType !== 'mute') {
            while (state.nextNoteTime < AudioEngine.ctx.currentTime + lookahead) {
                AudioEngine.playSynth(p.soundType, state.nextNoteTime);
                const secondsPerBeat = 60.0 / p.bpm;
                state.nextNoteTime += secondsPerBeat;
            }
        } else {
             state.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
        }
    }

    function toggleTimerState() {
        const now = Date.now();
        if (now - lastToggleTime < 300) return;
        lastToggleTime = now;

        AudioEngine.init(); 
        playClick();

        if (state.isRunning) {
            clearInterval(state.timerId); 
            state.isRunning = false;
            cancelAnimationFrame(ringFrameId);
            
            if(state.endTime > 0) state.remainingMs = Math.max(0, state.endTime - Date.now());
            toggleWakeLock(false);
            saveSession(currentMode); 
            UI['statusText'].innerText = t('status_paused');
            UI['metro-needle'].classList.remove('active');
            
        } else {
            toggleWakeLock(true);
            if(state.phase === 'finished') { state.phase = 'idle'; state.isRunning = false; resetTimer(false); state.isRunning = true; } 
            else { state.isRunning = true; }
            
            const p = presets[currentMode];

            // [FIX] Physics Init
            lastFrameTime = Date.now();

            // Phase init logic
            if(state.phase === 'idle') {
                if (p.prep > 0) { state.phase = 'prep'; state.timeLeft = p.prep; state.phaseDuration = p.prep; announce(t('phase_prep'), "start"); }
                else if (p.warmupOn) { state.phase = 'warmup'; state.timeLeft = p.warmupTime; state.phaseDuration = p.warmupTime; announce(t('phase_start_warmup'), "start"); }
                else { 
                    state.phase = 'work'; 
                    state.timeLeft = (currentMode === 'jog') ? p.duration : p.work; 
                    state.phaseDuration = state.timeLeft; 
                    if(currentMode === 'jog') {
                        announce(t('phase_jog'), "start");
                        state.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
                        UI['metro-needle'].classList.add('active');
                    } else {
                        announce(t('phase_start_work'), "start"); 
                    }
                }
            } else if(currentMode === 'jog' && state.phase === 'work') {
                state.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
                UI['metro-needle'].classList.add('active');
            }

            const durationMs = (state.remainingMs > 0) ? state.remainingMs : (state.timeLeft * 1000);
            state.endTime = Date.now() + durationMs; 
            state.remainingMs = 0;
            
            state.timerId = setInterval(() => {
                tick();
                if(currentMode === 'jog') scheduleMetronome();
            }, 50); 
            
            updateRingLoop(); 
            updateDisplay();
        }
        updateSafeguards(); updateActionBtnState();
    }

    function tick() {
        if(!state.isRunning) return; 

        const now = Date.now();
        const diff = state.endTime - now;
        
        if (diff <= 0) {
            state.timeLeft = 0; 
            UI['ringProgress'].style.strokeDashoffset = 1005; 
            UI['timerDigits'].innerText = "00:00"; 
            clearInterval(state.timerId); 
            
            // [CRITICAL FIX] Only finish if it's the actual WORK phase
            if(currentMode === 'jog' && state.phase === 'work') finishAll();
            else nextPhase(); 
            return;
        }

        const newTimeLeft = Math.ceil(diff / 1000);
        if (newTimeLeft !== state.timeLeft) {
            state.timeLeft = newTimeLeft;
            // Standard countdown sounds (except Jog Work phase)
            if (!(currentMode === 'jog' && state.phase === 'work') && state.timeLeft <= 3) {
                 if(soundMode==='beep') announce("", "tick");
                 if(soundMode==='voice') speak(state.timeLeft);
            }
            updateTextDisplay();
        }
    }

    function updateRingLoop() {
        if(!state.isRunning) return;
        const now = Date.now();
        const leftMs = Math.max(0, state.endTime - now);
        const totalMs = state.phaseDuration * 1000;
        const totalLength = 1005; 
        
        // [FIX] Physics Driven Needle
        if(currentMode === 'jog' && state.phase === 'work') {
            const dt = (now - lastFrameTime) / 1000;
            const bpm = presets.jog.bpm;
            // Calculate speed in radians per second based on BPM
            const speed = Math.PI * (bpm / 60); 
            state.needlePhase += speed * dt;
            const angle = 35 * Math.sin(state.needlePhase);
            UI['metro-needle'].style.transform = `rotate(${angle}deg)`;
        } else {
            UI['metro-needle'].style.transform = `rotate(0deg)`;
        }
        lastFrameTime = now;

        if(totalMs <= 0) { UI['ringProgress'].style.strokeDashoffset = totalLength; } 
        else { 
            const ratio = leftMs / totalMs; 
            UI['ringProgress'].style.strokeDashoffset = totalLength * (1 - ratio); 
        }
        ringFrameId = requestAnimationFrame(updateRingLoop);
    }

    function nextPhase() {
        clearInterval(state.timerId);
        const p = presets[currentMode];
        let nextT = 0; let nextType = ''; let txt = ''; let nextP = '';

        // [CRITICAL FIX] JOG MODE SEPARATE LOGIC
        if(currentMode === 'jog') {
            if(state.phase === 'prep') {
                if(p.warmupOn) { 
                    nextP = 'warmup'; 
                    nextT = p.warmupTime; 
                    txt = t('phase_start_warmup'); 
                    nextType = 'start'; 
                } else { 
                    nextP = 'work'; 
                    nextT = p.duration; 
                    txt = t('phase_jog'); 
                    nextType = 'start'; 
                }
            }
            else if(state.phase === 'warmup') {
                // FORCE to work phase with correct duration
                nextP = 'work'; 
                nextT = p.duration; 
                txt = t('phase_jog'); 
                nextType = 'start';
            }
        } 
        // STANDARD FLOW
        else {
            if (state.phase === 'prep') {
                if (p.warmupOn) { nextP = 'warmup'; nextT = p.warmupTime; txt = t('phase_start_warmup'); nextType = 'start'; } 
                else { nextP = 'work'; nextT = p.work; txt = t('phase_start_work'); nextType = 'start'; }
            }
            else if (state.phase === 'warmup') {
                nextP = 'work'; nextT = p.work; txt = t('phase_start_work'); nextType = 'start';
            }
            else if (state.phase === 'work') {
                if (p.type === 'loop') { finishRound(p); return; }
                else { nextP = 'rest'; nextT = p.rest; txt = t('phase_start_rest'); nextType = 'rest'; }
            }
            else if (state.phase === 'rest') {
                finishRound(p); return;
            }
        }

        if (nextT > 0) {
             state.phase = nextP; state.timeLeft = nextT; state.phaseDuration = nextT;
             announce(txt, nextType);
             
             // Activate visual needle ONLY for jog work phase
             if(currentMode === 'jog' && state.phase === 'work') {
                 state.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
                 UI['metro-needle'].classList.add('active');
             } else {
                 UI['metro-needle'].classList.remove('active');
             }
             
             startTimerLoop();
        } else if (nextT === 0 && nextP !== '') {
            state.phase = nextP; state.timeLeft = 0; nextPhase(); 
        }
    }

    function finishRound(p) {
        if (state.currentRound < p.rounds) {
            state.currentRound++; 
            state.phase = 'work'; state.timeLeft = p.work; state.phaseDuration = p.work;
            announce(t(currentMode === 'gym' ? 'phase_gym_start' : 'phase_start_work'), "start");
            startTimerLoop();
        } else { finishAll(); }
    }
    
    function startTimerLoop() {
        state.endTime = Date.now() + (state.timeLeft * 1000);
        updateDisplay();
        state.timerId = setInterval(() => {
            tick();
            if(currentMode === 'jog') scheduleMetronome();
        }, 50); 
        updateRingLoop(); 
    }

    function finishAll() {
        state.phase = 'finished'; state.timeLeft = 0; totalRemainingSeconds = 0;
        announce(t('phase_finish_train'), "finish");
        state.isRunning = false; toggleWakeLock(false);
        clearSession(currentMode); 
        cancelAnimationFrame(ringFrameId);
        UI['metro-needle'].classList.remove('active');
        updateSafeguards(); updateActionBtnState(); updateDisplay(); startConfetti(); 
    }

    function updateDisplay() {
        updateTextDisplay();
        
        const p = presets[currentMode];
        const ring = UI['ringProgress'];
        const totalLength = 1005; 
        const duration = state.phaseDuration > 0 ? state.phaseDuration : 1;
        
        let currentLeft = (state.remainingMs > 0) ? (state.remainingMs/1000) : state.timeLeft;
        let ratio = currentLeft / duration; 
        if(ratio > 1) ratio = 1; 
        if(ratio < 0) ratio = 0;
        
        const offset = totalLength * (1 - ratio);
        
        if (state.phase === 'finished') ring.style.strokeDashoffset = totalLength; 
        else if(!state.isRunning) ring.style.strokeDashoffset = offset; 
        
        if(currentMode === 'jog') ring.style.stroke = '#BF5AF2';
        else if(state.phase === 'rest') ring.style.stroke = '#30D158';
        else if(state.phase === 'warmup' || state.phase === 'prep') ring.style.stroke = '#BF5AF2';
        else ring.style.stroke = p.color || '#fff';

        UI['roundsText'].innerText = `${t('label_rounds')} ${state.currentRound} / ${p.rounds}`;
        
        let text = '', bg = 'var(--state-bg-idle)';
        if(currentMode === 'jog') {
             text = (state.phase === 'finished') ? t('phase_finish') : t('phase_jog');
             if(state.phase === 'prep') { text = t('phase_prep'); bg = 'var(--state-bg-idle)'; }
             /* [FIX] Warmup Orange */
             else if(state.phase === 'warmup') { text = t('phase_warmup'); bg = 'var(--state-bg-warmup)'; }
             else if(state.phase === 'work') { text = t('phase_jog'); bg = 'var(--state-bg-jog)'; }
             else if(state.phase === 'finished') { text = t('phase_finish'); bg = 'var(--state-bg-finish)'; }
        } else {
            if (state.phase === 'idle' || state.phase === 'prep') { text = t('phase_prep'); bg = 'var(--state-bg-idle)'; }
            /* [FIX] Warmup Orange */
            else if (state.phase === 'warmup') { text = t('phase_warmup'); bg = 'var(--state-bg-warmup)'; }
            else if (state.phase === 'work') { text = (currentMode === 'gym') ? t('phase_gym_work') : t('phase_work'); bg = 'var(--state-bg-work)'; }
            else if (state.phase === 'rest') { text = (currentMode === 'gym') ? t('phase_gym_rest') : t('phase_rest'); bg = 'var(--state-bg-rest)'; }
            else if (state.phase === 'finished') { text = t('phase_finish'); bg = 'var(--state-bg-finish)'; }
        }
        
        if(state.isRunning || state.phase === 'idle' || state.phase === 'finished') {
            UI['statusText'].innerText = text; 
        }
        
        UI['state-overlay'].style.backgroundColor = bg;
    }

    function updateTextDisplay() {
        if(currentMode === 'jog' && state.phase === 'work') {
             totalRemainingSeconds = state.timeLeft;
        } else {
             const p = presets[currentMode];
             if(state.phase === 'idle') {
                 totalRemainingSeconds = calcTotalDuration(p);
             } else {
                 // Estimation logic
                 let future = 0;
                 if(state.phase !== 'finished') {
                     if(currentMode === 'jog') {
                         if(state.phase === 'prep' || state.phase === 'warmup') {
                             future = p.duration;
                             if(state.phase === 'prep' && p.warmupOn) future += p.warmupTime;
                         }
                     } else {
                         const roundsLeft = p.rounds - state.currentRound;
                         if(state.phase === 'work') future = p.rest + (roundsLeft * (p.work + p.rest));
                         else if(state.phase === 'rest') future = (roundsLeft * (p.work + p.rest));
                         else if(state.phase === 'prep' || state.phase === 'warmup') {
                             future = (p.rounds * (p.work + p.rest));
                             if(state.phase === 'prep' && p.warmupOn) future += p.warmupTime;
                         }
                     }
                 }
                 totalRemainingSeconds = state.timeLeft + future;
             }
        }
        UI['timerDigits'].innerText = formatTime(state.timeLeft);
        UI['totalRemainDisplay'].innerText = `${t('label_total_remain')}: ${formatTime(totalRemainingSeconds)}`;
    }

    function updateSafeguards() {
        const isIdle = (state.phase === 'idle');
        const isFinished = (state.phase === 'finished');
        const isPaused = !state.isRunning && !isIdle && !isFinished;

        if (isPaused || isFinished) { 
            UI['btnReset'].classList.remove('btn-locked'); 
            UI['btnReset'].classList.add('btn-pulse');
        } else { 
            UI['btnReset'].classList.add('btn-locked'); 
            UI['btnReset'].classList.remove('btn-pulse');
        }
        
        const locks = document.querySelectorAll('.lockable');
        if (isIdle || isFinished) locks.forEach(b => b.classList.remove('disabled')); else locks.forEach(b => b.classList.add('disabled'));
    }

    function updateActionBtnState() {
        const wrapper = UI['play-icon-wrap'];
        const btn = UI['actionBtn'];
        
        if(state.isRunning) {
            btn.classList.add('running');
            wrapper.innerHTML = `<svg class="icon-svg"><use href="#icon-pause"></use></svg><span>${t('btn_pause')}</span>`;
        } else {
            btn.classList.remove('running');
             let txt = (state.phase === 'idle' || state.phase === 'finished') ? t('btn_start') : t('btn_resume');
             wrapper.innerHTML = `<svg class="icon-svg"><use href="#icon-play"></use></svg><span>${txt}</span>`;
        }
    }

    function formatTime(seconds) {
        if(isNaN(seconds) || seconds < 0) seconds = 0;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function validateInput(el) {
        if(el.value.length > 1 && el.value.startsWith('0')) el.value = parseInt(el.value);
        let max = 99; 
        if(el.id.includes('sec')) max = 59; 
        if(el.id.includes('rounds')) max = 999;
        if(el.value === '') { el.value = 0; return; }
        let val = parseInt(el.value); 
        if(isNaN(val) || val < 0) val = 0; 
        if(val > max) val = max; 
        el.value = val;
    }

    function getTimeFromInputs(idPrefix) {
        if(idPrefix === 'set-jog') {
             return (parseInt(UI['set-jog-min'].value) || 30) * 60;
        }
        if(idPrefix === 'set-jog-prep') {
             const min = parseInt(UI['set-jog-prep-min'].value) || 0;
             const sec = parseInt(UI['set-jog-prep-sec'].value) || 0;
             return (min * 60) + sec;
        }
        if(idPrefix === 'set-jog-warmup') {
             const min = parseInt(UI['set-jog-warmup-min'].value) || 0;
             const sec = parseInt(UI['set-jog-warmup-sec'].value) || 0;
             return (min * 60) + sec;
        }
        const min = parseInt(document.getElementById(idPrefix + '-min').value) || 0;
        const sec = parseInt(document.getElementById(idPrefix + '-sec').value) || 0;
        return (min * 60) + sec;
    }

    function liveUpdateTotal() {
        let total = 0;
        if(currentMode === 'jog') {
            const p = presets['jog'];
            total = getTimeFromInputs('set-jog') + getTimeFromInputs('set-jog-prep');
            if(p.warmupOn) total += getTimeFromInputs('set-jog-warmup');
        } else {
             const p = presets[currentMode];
             const tempP = {
                prep: getTimeFromInputs('set-prep'),
                warmupTime: getTimeFromInputs('set-warmup'),
                work: getTimeFromInputs('set-work'),
                rest: getTimeFromInputs('set-rest'),
                rounds: Math.max(1, parseInt(UI['set-rounds'].value) || 1),
                warmupOn: p.warmupOn,
                type: p.type
            };
            total = calcTotalDuration(tempP);
        }
        UI['modalTotalTime'].innerText = `${t('label_total_est')}: ${formatTime(total)}`;
    }

    function openSettings() { 
        if(document.querySelectorAll('.lockable')[0].classList.contains('disabled')) return;
        playClick(); UI['settings-modal'].classList.add('open'); loadSettingsToUI(); liveUpdateTotal();
    }
    function closeSettings() { playClick(); saveSettingsFromUI(); UI['settings-modal'].classList.remove('open'); updateWarmupUI(); resetTimer(false); }

    function loadSettingsToUI() {
        const p = presets[currentMode];
        const setVal = (id, val) => UI[id].value = val;
        
        if(currentMode === 'jog') {
            UI['group-standard'].classList.add('hidden');
            UI['group-jog'].classList.remove('hidden');
            setVal('set-jog-min', Math.floor(p.duration/60));
            setVal('set-jog-prep-min', Math.floor(p.prep/60)); setVal('set-jog-prep-sec', p.prep%60);
            setVal('set-jog-warmup-min', Math.floor(p.warmupTime/60)); setVal('set-jog-warmup-sec', p.warmupTime%60);
        } else {
            UI['group-standard'].classList.remove('hidden');
            UI['group-jog'].classList.add('hidden');
            setVal('set-prep-min', Math.floor(p.prep/60)); setVal('set-prep-sec', p.prep%60);
            setVal('set-warmup-min', Math.floor(p.warmupTime/60)); setVal('set-warmup-sec', p.warmupTime%60);
            setVal('set-work-min', Math.floor(p.work/60)); setVal('set-work-sec', p.work%60);
            setVal('set-rest-min', Math.floor(p.rest/60)); setVal('set-rest-sec', p.rest%60);
            setVal('set-rounds', p.rounds);
            UI['row-work'].style.display = (p.type === 'countdown') ? 'none' : 'flex';
        }
    }

    function saveSettingsFromUI() {
        const p = presets[currentMode];
        if(currentMode === 'jog') {
             p.duration = getTimeFromInputs('set-jog');
             p.prep = getTimeFromInputs('set-jog-prep');
             p.warmupTime = getTimeFromInputs('set-jog-warmup');
        } else {
            p.prep = getTimeFromInputs('set-prep'); p.warmupTime = getTimeFromInputs('set-warmup');
            p.work = getTimeFromInputs('set-work'); p.rest = getTimeFromInputs('set-rest');
            p.rounds = Math.max(1, parseInt(UI['set-rounds'].value));
        }
        localStorage.setItem('fitloopSettings', JSON.stringify(presets));
    }

    function restoreDefaults() {
        if(confirm("Restore defaults?")) { 
            playClick(); 
            presets[currentMode] = JSON.parse(JSON.stringify(defaultPresets[currentMode])); 
            localStorage.setItem('fitloopSettings', JSON.stringify(presets)); 
            loadSettingsToUI(); liveUpdateTotal(); 
        }
    }

    function toggleWarmupDirect() {
        if(UI['btn-warmup'].classList.contains('disabled')) return;
        playClick(); const p = presets[currentMode]; p.warmupOn = !p.warmupOn;
        localStorage.setItem('fitloopSettings', JSON.stringify(presets)); updateWarmupUI(); resetTimer(false);
    }

    // --- Metronome Menu Functions ---
    function openMetronomeModal() {
        playClick();
        UI['metro-modal'].classList.add('open');
        updateMetronomeUI(); // highlight current selection
    }
    function closeMetronomeModal() { playClick(); UI['metro-modal'].classList.remove('open'); }

    function setMetronomeSound(type) {
        presets.jog.soundType = type;
        localStorage.setItem('fitloopSettings', JSON.stringify(presets));
        
        // Visual feedback
        document.querySelectorAll('#metro-modal .lang-opt').forEach(el => el.classList.remove('selected-opt'));
        document.getElementById('opt-'+type).classList.add('selected-opt');
        
        updateMetronomeUI();
        if(type !== 'mute') AudioEngine.playSynth(type);
        
        // If running, update next note logic
        if(state.isRunning) state.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
    }

    function updateMetronomeUI() {
        const type = presets.jog.soundType;
        const btnText = UI['text-metronome'];
        
        let label = 'Wood';
        if(type === 'mute') label = 'Mute';
        else if(type === 'digital') label = 'Digi';
        else if(type === 'kick') label = 'Kick';
        else if(type === 'click') label = 'Tick';
        
        btnText.innerText = label;
        
        // In Modal
        document.querySelectorAll('#metro-modal .lang-opt').forEach(el => el.classList.remove('selected-opt'));
        if(document.getElementById('opt-'+type)) document.getElementById('opt-'+type).classList.add('selected-opt');
    }
    
    function updateWarmupUI() {
        const p = presets[currentMode]; 
        if(p.warmupOn) { UI['btn-warmup'].classList.add('btn-active-green'); UI['text-warmup'].innerText = t('btn_warmup_on'); } 
        else { UI['btn-warmup'].classList.remove('btn-active-green'); UI['text-warmup'].innerText = t('btn_warmup_off'); }
    }

    function adjustBPM(change) {
        const p = presets['jog'];
        let newBPM = p.bpm + change;
        if(newBPM < 30) newBPM = 30;
        if(newBPM > 240) newBPM = 240;
        p.bpm = newBPM;
        UI['bpmDisplay'].innerText = newBPM;
        localStorage.setItem('fitloopSettings', JSON.stringify(presets));
        // Note: No need to update CSS animation duration anymore
    }
    
    function toggleSoundMode() {
        playClick();
        if (soundMode === 'beep') soundMode = 'voice'; else if (soundMode === 'voice') soundMode = 'mute'; else soundMode = 'beep';
        localStorage.setItem('fitloopSoundMode', soundMode); // Persistence
        updateSoundUI();
        if(soundMode === 'voice') speak(t('sound_voice')); else if(soundMode === 'beep') AudioEngine.play(800, 'sine', 0.1, 0.3);
    }
    function updateSoundUI() {
        const text = UI['text-sound']; const icon = UI['icon-sound'];
        if (soundMode === 'voice') { text.innerText = t('sound_voice'); icon.innerHTML='<svg class="icon-svg"><use href="#icon-sound-voice"></use></svg>';}
        else if (soundMode === 'beep') { text.innerText = t('sound_beep'); icon.innerHTML='<svg class="icon-svg"><use href="#icon-sound-beep"></use></svg>';}
        else { text.innerText = t('sound_mute'); icon.innerHTML='<svg class="icon-svg"><use href="#icon-sound-mute"></use></svg>';}
    }

    function playClick() { AudioEngine.play(1200, 'triangle', 0.05, 0.02); }
    function announce(text, type) {
        if (soundMode === 'mute') return;
        if (soundMode === 'voice') speak(text);
        else {
            if (type === 'start') AudioEngine.play(880, 'sine', 0.4, 0.3); 
            else if (type === 'rest') AudioEngine.play(440, 'sine', 0.4, 0.3);
            else if (type === 'tick') AudioEngine.play(600, 'sine', 0.05, 0.3); 
            else if (type === 'finish') { AudioEngine.play(880, 'square', 0.1, 0.3, 0); AudioEngine.play(880, 'square', 0.1, 0.3, 0.15); }
        }
    }
    function speak(text) {
        if ('speechSynthesis' in window) { 
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text); u.rate = 1.1; u.lang = currentLang; 
            window.speechSynthesis.speak(u); 
        }
    }

    function startConfetti() {
        if(confettiActive) return;
        confettiActive = true;
        const canvas = UI['confetti-canvas'];
        canvas.classList.add('active');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const colors = ['#ff3b30', '#ff9f0a', '#30d158', '#0a84ff', '#bf5af2', '#64d2ff', '#ffffff'];
        let particles = [];
        for(let i=0; i<100; i++) {
            particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, w: Math.random()*8+4, h: Math.random()*8+4, color: colors[Math.floor(Math.random()*colors.length)], speed: Math.random()*3+2, angle: Math.random()*360, spin: Math.random()*0.2-0.1 });
        }
        function draw() {
            if(!confettiActive) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let active = false;
            particles.forEach(p => {
                p.y += p.speed; p.angle += p.spin;
                if(p.y < canvas.height) active = true;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
            });
            if(active) requestAnimationFrame(draw); 
            else stopConfetti();
        }
        draw();
    }
    function stopConfetti() {
        confettiActive = false;
        const canvas = UI['confetti-canvas'];
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        canvas.classList.remove('active');
    }

    return {
        init, selectMode, goBack, resetTimer, toggleTimerState, toggleSoundMode, 
        toggleWarmupDirect, openSettings, closeSettings, restoreDefaults, 
        openLangModal, closeLangModal, setLanguage, openInfoModal, closeInfoModal, toggleTheme, 
        adjustBPM, openMetronomeModal, closeMetronomeModal, setMetronomeSound
    };

})();

window.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>